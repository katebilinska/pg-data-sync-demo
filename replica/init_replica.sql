CREATE TABLE IF NOT EXISTS t1 (
    event_date timestamptz NOT NULL,
    id bigserial NOT NULL,
    amount numeric(14,2) NOT NULL DEFAULT 0,
    state smallint NOT NULL DEFAULT 0,
    operation_guid uuid NOT NULL,
    message jsonb NOT NULL,
    client_id int GENERATED ALWAYS AS ((message->>'client_id')::int) STORED,
    op_type text GENERATED ALWAYS AS (message->>'op_type') STORED,
    created_at timestamptz NOT NULL DEFAULT now()
) PARTITION BY RANGE (event_date);

ALTER TABLE t1 ADD CONSTRAINT t1_operation_guid_unique UNIQUE (event_date, operation_guid);

CREATE INDEX IF NOT EXISTS t1_idx_state_id ON t1 (state, id);
CREATE INDEX IF NOT EXISTS t1_idx_client_optype ON t1 (client_id, op_type);

CREATE TABLE IF NOT EXISTS t1_p_2025_09 PARTITION OF t1
    FOR VALUES FROM ('2025-09-01 00:00:00+00') TO ('2025-10-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS t1_p_2025_10 PARTITION OF t1
    FOR VALUES FROM ('2025-10-01 00:00:00+00') TO ('2025-11-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS t1_p_2025_11 PARTITION OF t1
    FOR VALUES FROM ('2025-11-01 00:00:00+00') TO ('2025-12-01 00:00:00+00');
CREATE TABLE IF NOT EXISTS t1_p_2025_12 PARTITION OF t1
    FOR VALUES FROM ('2025-12-01 00:00:00+00') TO ('2026-01-01 00:00:00+00');

ALTER TABLE t1_p_2025_09 REPLICA IDENTITY FULL;
ALTER TABLE t1_p_2025_10 REPLICA IDENTITY FULL;
ALTER TABLE t1_p_2025_11 REPLICA IDENTITY FULL;
ALTER TABLE t1_p_2025_12 REPLICA IDENTITY FULL;